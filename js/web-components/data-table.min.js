import{render,buildUrl,polyfillCustomElements}from"./utils.min.js";import{Format}from"./utils-format.min.js";const shadowTmpl=document.createElement("template");function toggleHighlight(t){const e=t.target.nodeName;"A"!==e&&"INPUT"!==e&&"SELECT"!==e&&"TEXTAREA"!==e&&"BUTTON"!==e&&this.classList.toggle("highlight")}shadowTmpl.innerHTML="\n    <style>\n        :host { display: block; }\n        :host([hidden]) { display: none; }\n    </style>\n    <slot></slot>\n";class DataTable extends HTMLElement{constructor(){super();this.attachShadow({mode:"open"}).appendChild(shadowTmpl.content.cloneNode(!0)),this.state={list:null,hasBeenLoaded:!1}}static get observedAttributes(){return["col-link-template","col-link-fields","col-class","columns","labels","table-attr","highlight-class"]}attributeChangedCallback(t,e){switch(t){case"col-link-template":case"col-link-fields":case"col-class":case"columns":case"labels":case"table-attr":case"highlight-class":case"empty-data-text":(null!==e||this.state.hasBeenLoaded)&&this.renderTable()}}get value(){return this.state.list}set value(t){this.state.list=t,this.renderTable()}get errorClass(){return this.getAttribute("error-class")}get defaultErrorStyle(){return"color:white; background-color:red; padding:0.5rem 1rem; margin:.5rem;"}get emptyDataText(){const t=this.getAttribute("empty-data-text");return null===t?"No records found":t}getTemplate(){let t=this.querySelector("template:not([data-footer])");return null===t&&(t=this.querySelector('script[type="text/x-template"]:not([data-footer])')),t}getFooterTemplate(){let t=this.querySelector("template[data-footer]");return null===t&&(t=this.querySelector('script[type="text/x-template"][data-footer]')),t}removeTable(){if(null===this.getTemplate()&&null===this.getFooterTemplate())return void(this.innerHTML="");const t=this.querySelector("table");null!==t&&t.parentNode.removeChild(t)}renderTable(){const t=this.state.list;if(null===t||""===t)return void this.removeTable();this.state.hasBeenLoaded=!0;const e=this.getTemplate(),r=this.getFooterTemplate(),s=t=>{null===e&&null===r?this.innerHTML=t:(this.removeTable(),this.insertAdjacentHTML("beforeend",t))},l=t=>{const e=this.errorClass;s(e?render`<table class="${this.errorClass}"><caption>Error Rendering Template - ${t}</caption></table>`:render`<table><caption style="display:block; ${this.defaultErrorStyle}">Error Rendering Template - ${t}</caption></table>`)};if(Array.isArray(t)&&0===t.length)return void s(render`<table class="no-data"><caption style="display:block;">${this.emptyDataText}</caption></table>`);let n=!0;if(Array.isArray(t)?t.length>0&&"object"!=typeof t[0]&&(n=!1):n=!1,!n)return void l("Error invalid data type for <data-table>, an array of objects is required.");const o=this.getAttribute("columns"),a=o?o.split(",").map((t=>t.trim())):Object.keys(t[0]);let i=a,h=this.getAttribute("labels");h&&(i=h.split(",").map((t=>t.trim())),i.length!==a.length&&null===e&&(i=a));let c="<table",d=this.getAttribute("table-attr");if(d){d=d.split(",").map((t=>t.trim()));for(const t of d){const e=t.indexOf("=");if(e>1){const r=t.substring(0,e).trim(),s=t.substring(e+1).trim();c+=render` ${r}="${s}"`}else c+=render` ${t}`}}const u=this.getAttribute("col-class"),p=[];if(p.push(`${c}><thead><tr>`),u){const t=u.split(",").map((t=>t.trim())),e={};for(const r of t){const t=r.indexOf("=");if(t>0){const s=r.substring(0,t),l=r.substring(t+1);e[s]=l}}for(let t=0,r=i.length;t<r;t++){const r=i[t];let s;void 0!==e[t.toString()]?s=e[t.toString()]:void 0!==e[r]&&(s=e[r]),s?p.push(render`<th class="${s}">${r}</th>`):p.push(render`<th>${r}</th>`)}}else for(const t of i)p.push(render`<th>${t}</th>`);if(p.push("</tr></thead>"),p.push("<tbody>"),e)try{const r=this.getAttribute("row-item-name");let s;s=r?new Function(r,"index","render","format","return render`"+e.innerHTML+"`"):new Function("item","index","render","format","with(item){return render`"+e.innerHTML+"`}");let l=0;const n=new Format;for(const e of t){try{p.push(s(e,l,render,n))}catch(t){this.errorClass?p.push(render`<tr class="${this.errorClass}">`):p.push(render`<tr style="${this.defaultErrorStyle}">`),p.push(render`<td colspan="${a.length}">Item Error - ${t.message}</td></tr>`)}l++}}catch(t){return void l("Error Rendering Template - "+t.message)}else{const e=this.getAttribute("col-link-template");let r=this.getAttribute("col-link-fields");e&&(r=r?r.split(",").map((t=>t.trim())):[a[0]]);for(const s of t){const t=[];t.push("<tr>");for(const l of a)e&&r.includes(l)?t.push(render`<td>
                            <a href="${buildUrl(e,s)}">${s[l]}</a>
                        </td>`):t.push(render`<td>${s[l]}</td>`);t.push("</tr>"),p.push(t.join(""))}}if(r){p.push("<tfoot>");const e=e=>{const r=[];for(const s of t){let t=s[e];switch(typeof t){case"number":r.push(t);break;case"string":t=parseFloat(t),isNaN(t)||r.push(t)}}return r},s=t=>e(t).reduce(((t,e)=>t+e),0),n=t=>{const r=e(t);return r.reduce(((t,e)=>t+e),0)/r.length},o=t=>Math.max.apply(null,e(t)),i=t=>Math.min.apply(null,e(t)),h=()=>t.length;try{const t=new Function("render","format","sum","avg","max","min","count","return render`"+r.innerHTML+"`"),e=new Format;try{p.push(t(render,e,s,n,o,i,h))}catch(t){this.errorClass?p.push(render`<tr class="${this.errorClass}">`):p.push(render`<tr style="${this.defaultErrorStyle}">`),p.push(render`<td colspan="${a.length}">Footer Error - ${t.message}</td></tr>`)}}catch(t){return void l("Error Rendering Footer Template - "+t.message)}p.push("</tfoot>")}p.push("</tbody></table>"),s(p.join(""));if(this.getAttribute("highlight-class")){const t=this.querySelectorAll("tbody tr");for(const e of t)e.style.cursor="pointer",e.addEventListener("click",toggleHighlight)}polyfillCustomElements(this)}}window.customElements.define("data-table",DataTable);