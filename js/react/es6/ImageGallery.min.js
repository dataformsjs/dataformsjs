import React from"react";let _supportsPassive=!1;try{const e=Object.defineProperty({},"passive",{get:function(){return _supportsPassive=!0,!0}});window.addEventListener("testPassive",null,e),window.removeEventListener("testPassive",null,e)}catch(e){}const isMobile=(()=>{const e=window.navigator.userAgent.toLowerCase();return e.indexOf("android")>-1||e.indexOf("iphone")>-1||e.indexOf("ipad")>-1})();let supportsAvif=null,supportsWebp=null;function BasicImage(e){return React.createElement("img",{src:e.thumbnail,alt:e.title,tabIndex:e.tabIndex,onClick:e.onClick,onKeyDown:e.onKeyDown})}export default class ImageGallery extends React.Component{constructor(e){super(e),this.onClick=this.onClick.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.handleDocKeyDown=this.handleDocKeyDown.bind(this),this.preloadNextImages=this.preloadNextImages.bind(this),this.showOverlay=this.showOverlay.bind(this),this.hideOverlay=this.hideOverlay.bind(this),this.changeImage=this.changeImage.bind(this),this.svgForwardButton='<svg width="13" height="22" xmlns="http://www.w3.org/2000/svg"><path d="M3.4.6L12 9c.4.4.6 1 .6 1.5a2 2 0 01-.6 1.5l-8.5 8.5a2 2 0 01-2.8-2.8l7.2-7.2L.6 3.4A2 2 0 013.4.6z" fill="#fff" fill-rule="evenodd"/></svg>',this.svgBackButton='<svg width="13" height="22" xmlns="http://www.w3.org/2000/svg"><path d="M9 .6L.7 9a2 2 0 00-.6 1.5c0 .5.2 1.1.6 1.5L9 20.6a2 2 0 002.8-2.8l-7.2-7.2L12 3.4A2 2 0 009.1.6z" fill="#fff" fill-rule="evenodd"/></svg>',this.overlayStyleId="image-gallery-css",this.overlayStyleCss=`\n            body.blur { filter: blur(3px); }\n\n            .image-gallery-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background-color: rgba(255,255,255,.8);\n                cursor: pointer;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                flex-direction: column;\n            }\n\n            .image-gallery-overlay .image-gallery-loading {\n                font-weight: bold;\n                padding: 10px 20px;\n                background-color: rgba(255,255,255,.4);\n                position: absolute;\n            }\n\n            .image-gallery-overlay img {\n                max-width: 100%;\n                max-height: 100%;\n                flex-shrink: 0;\n            }\n\n            .image-gallery-overlay div {\n                position: absolute;\n                bottom: 0;\n                left: 0;\n                right: 0;\n                z-index: 2;\n                font-weight: bold;\n                display: flex;\n                justify-content: space-between;\n                width: 100%;\n            }\n\n            .image-gallery-overlay div span {\n                padding: 10px 20px;\n                background-color: rgba(255,255,255,.4);\n            }\n\n            .image-gallery-overlay .btn-previous,\n            .image-gallery-overlay .btn-next {\n                display: block;\n                position: absolute;\n                height: 40px;\n                width: 40px;\n                opacity: .7;\n                background-repeat: no-repeat;\n                background-position: center;\n                padding: 0;\n                margin: 15px;\n                background-color: rgba(0,0,0,.5);\n                border-radius: 50%;\n                transition: all ease-in-out .2s;\n            }\n            .image-gallery-overlay .btn-previous { left: 0; background-position-x: 12px; background-image: url("data:image/svg+xml;base64,${btoa(this.svgBackButton)}"); }\n            .image-gallery-overlay .btn-next { right: 0; background-position-x: 15px; background-image: url("data:image/svg+xml;base64,${btoa(this.svgForwardButton)}"); }\n\n            .image-gallery-overlay .btn-previous:hover,\n            .image-gallery-overlay .btn-next:hover {\n                opacity: .5;\n            }       \n\n            .image-gallery-overlay.mobile .btn-previous,\n            .image-gallery-overlay.mobile .btn-next,\n            .image-gallery-overlay.keyboard .btn-previous,\n            .image-gallery-overlay.keyboard .btn-next {\n                display: none;\n            }\n\n            @media (min-width: 1300px) {\n                .image-gallery-overlay div {\n                    left: calc((100% - 1300px) /2);\n                    right: auto;\n                    max-width: 1300px;\n                }\n            }\n\n            @media screen and (-ms-high-contrast: active), screen and (-ms-high-contrast: none) {\n                .image-gallery-overlay .image-gallery-loading,\n                .image-gallery-overlay .btn-previous,\n                .image-gallery-overlay .btn-next { margin-top: calc((100vh /2) - 35px); }\n            }\n        `,this.imageIndex=null,this.overlay=null,this.overlayImg=null,this.overlayTitle=null,this.overlayIndex=null,this.overlayLoading=null,this.overlayBackButton=null,this.overlayFowardButton=null,this.touchStartX=null,this.loadingTimeoutId=null,this.loadingText=e.loadingText?e.loadingText:"Loading...",this.loadingTimeout=e.loadingTimeout?e.loadingTimeout:2e3,this.loadedImages=new Set,this.startedFromKeyboard=!1,this.state={images:e.images}}onClick(e){let t=e.target.src;t||(t=e.target.getAttribute("data-image")),this.imageIndex=-1;for(let e=0,a=this.state.images.length;e<a;e++)if(this.state.images[e].thumbnail===t){this.imageIndex=e;break}this.checkSupportedFormats()}onKeyDown(e){" "!==e.key&&"Spacebar"!==e.key||(null===this.overlay&&(this.startedFromKeyboard=!0,this.onClick(e)),e.preventDefault())}loadCss(){let e=document.getElementById(this.overlayStyleId);null===e&&((e=document.createElement("style")).id=this.overlayStyleId,e.innerHTML=this.overlayStyleCss,document.head.appendChild(e))}checkSupportedFormats(){if(null!==supportsAvif&&null!==supportsWebp)return void this.showOverlay();const e=this.showOverlay;function t(){null===supportsAvif||null===supportsWebp||e()}const a=new Image;a.onload=(()=>{supportsAvif=1===a.width&&1===a.height,t()}),a.onerror=(()=>{supportsAvif=!1,t()}),a.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABoAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACJtZGF0EgAKCBgABogQEAwgMgwYAAAAUAAAALASmpg=";const i=new Image;i.onload=(()=>{supportsWebp=1===i.width&&1===i.height,t()}),i.onerror=(()=>{supportsWebp=!1,t()}),i.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA"}showOverlay(){const e=this.getImage(this.state.images[this.imageIndex]),t=this.state.images[this.imageIndex].title;this.loadCss(),this.overlay=document.createElement("div"),this.overlay.className="image-gallery-overlay"+(isMobile?" mobile":"")+(this.startedFromKeyboard?" keyboard":""),this.overlayLoading=document.createElement("span"),this.overlayLoading.className="image-gallery-loading",this.overlayLoading.textContent=this.loadingText,this.overlayLoading.setAttribute("hidden",""),this.overlay.appendChild(this.overlayLoading),this.overlayBackButton=document.createElement("span"),this.overlayBackButton.className="btn-previous",this.overlayBackButton.setAttribute("role","button"),this.overlayBackButton.onclick=(()=>{this.changeImage("left")}),this.overlayFowardButton=document.createElement("span"),this.overlayFowardButton.className="btn-next",this.overlayFowardButton.setAttribute("role","button"),this.overlayFowardButton.onclick=(()=>{this.changeImage("right")}),this.overlay.appendChild(this.overlayBackButton),this.overlay.appendChild(this.overlayFowardButton),this.overlayImg=document.createElement("img"),this.overlayImg.addEventListener("load",()=>{this.loadedImages.add(e),this.clearLoadingTimer(),null!==this.overlayLoading&&this.overlayLoading.setAttribute("hidden",""),this.preloadNextImages()}),this.overlayImg.src=e,this.overlay.appendChild(this.overlayImg);const a=document.createElement("div");this.overlayTitle=document.createElement("span"),this.overlayTitle.textContent=t,this.overlayTitle.style.display=t?"":"none",a.appendChild(this.overlayTitle),this.overlayIndex=document.createElement("span"),this.overlayIndex.textContent=`${this.imageIndex+1}/${this.state.images.length}`,a.appendChild(this.overlayIndex),this.overlay.appendChild(a),this.addOverlayEvents(),document.documentElement.appendChild(this.overlay),document.querySelector("body").classList.add("blur"),this.startLoadingTimer()}getImage(e){return void 0!==e.image_avif&&supportsAvif?e.image_avif:void 0!==e.image_webp&&supportsWebp?e.image_webp:e.image}startLoadingTimer(){this.clearLoadingTimer(),this.loadingTimeoutId=window.setTimeout(()=>{this.loadingTimeoutId=null,null!==this.overlayLoading&&this.overlayLoading.removeAttribute("hidden")},this.loadingTimeout)}clearLoadingTimer(){null!==this.loadingTimeoutId&&(window.clearTimeout(this.loadingTimeoutId),this.loadingTimeoutId=null)}addOverlayEvents(){this.overlay.onclick=(e=>{if("ontouchstart"in window){const t=window.innerHeight,a=t/4,i=t-a;if(e.clientY>=a&&e.clientY<=i)return}e.target!==this.overlayBackButton&&e.target!==this.overlayFowardButton&&this.hideOverlay()}),document.addEventListener("keydown",this.handleDocKeyDown),this.overlay.addEventListener("touchstart",e=>{this.touchStartX=e.changedTouches[0].screenX},!!_supportsPassive&&{passive:!0}),this.overlay.addEventListener("touchend",e=>{var t=e.changedTouches[0].screenX;t>this.touchStartX?this.changeImage("left"):t<this.touchStartX&&this.changeImage("right")})}handleDocKeyDown(e){switch(e.key){case"ArrowLeft":case"Left":this.changeImage("left");break;case"ArrowRight":case"Right":this.changeImage("right");break;case"Escape":case"Esc":this.hideOverlay()}}componentWillUnmount(){this.hideOverlay()}hideOverlay(){this.clearLoadingTimer(),this.overlay.parentNode.removeChild(this.overlay),this.overlayBackButton=null,this.overlayFowardButton=null,this.overlayLoading=null,this.overlayIndex=null,this.overlayTitle=null,this.overlayImg=null,this.overlay=null,this.startedFromKeyboard=!1,document.removeEventListener("keydown",this.handleDocKeyDown),document.querySelector("body").classList.remove("blur")}preloadNextImages(){if(-1===window.Image.toString().indexOf("[native code]"))return void console.warn("Images for <ImageGallery> cannot be preloaded because the app defined a <Image> component that overwrote the browsers native [Image] class.");const e=this.state.images.length;let t=this.imageIndex-1;if(-1===t&&(t=e-1),t!==this.imageIndex){const e=this.getImage(this.state.images[t]);if(e&&!this.loadedImages.has(e)){const t=new Image;t.onload=(()=>{this.loadedImages.add(e)}),t.src=e}}let a=this.imageIndex+1;if(a===e&&(a=0),a!==this.imageIndex){const e=this.getImage(this.state.images[a]);if(e&&!this.loadedImages.has(e)){const t=new Image;t.onload=(()=>{this.loadedImages.add(e)}),t.src=e}}}changeImage(e){const t=this.state.images.length;this.imageIndex="right"===e?this.imageIndex===t-1?0:this.imageIndex+1:0===this.imageIndex?t-1:this.imageIndex-1;const a=this.state.images[this.imageIndex].title;this.overlayImg.src="",this.overlayImg.src=this.getImage(this.state.images[this.imageIndex]),this.overlayTitle.textContent=a,this.overlayTitle.style.display=a?"":"none",this.overlayIndex.textContent=`${this.imageIndex+1}/${t}`,this.startLoadingTimer()}render(){let e=this.props.template;void 0===e&&(e=void 0!==this.props.children?this.props.children:React.createElement(BasicImage));let t=parseInt(this.props.tabIndex,10);const a=window.isFinite(t);return this.state.images.map(i=>{const n={onClick:this.onClick,onKeyDown:this.onKeyDown};return a&&(n.tabIndex=t,t++),React.cloneElement(e,Object.assign({},i,n))})}};